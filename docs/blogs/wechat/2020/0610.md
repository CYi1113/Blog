---
title: 微信小程序获取位置异常
date: 2020-06-10
tags:
 - 微信小程序 
categories:
 - 小程序
author: 11月
---


## 前言背景

::: tip
  早上还在上班的路上就收到了产品的连环艾特zzzZZZ。到公司后找到产品了解具体的细节：最近（昨天）有大量用户反馈定位异常，距离当前用户的位置偏差极大，导致用户选择了错误的门店下单，造成商户的实际损失。
:::

<!-- more -->

## 排查/复现问题
由于我们本地测试机无法复现，找产品提供出现异常的用户的订单信息。因为在之前的版本上线了埋点功能。所以直接找到相关埋点日志，根据订单id查找这个异常用户的操作信息。结果发现这个用户选择门店的时候经纬度是0，0 ？？？ 
```
[2020-06-01 23:58:03] [INFO] [source=mini-program/shop.go:48] query shop req:{Province: Name:古茗茶 Lng:0 Lat:0 Distance:0 Page:1 Size:10},openId:oMzAw5Tp4oOItnqP9iUUNbSOEVow
```
::: theorem come on
看到这个结果一脸黑线。。。 这说明获取定位操作是成功的，但是为什么返回的是0，0？ 接下来，我们过滤了昨天的日志，发现经纬度是0，0的埋点操作有2231次。且发现同一用户（openid一致）出现连续获取经纬度信息都为0，0的情况。与后端同学沟通得知，当用户经纬度为false时会直接拒掉。那么问题出现了，为什么这个用户可以查到门店并进行下单？
再次查看改用户的操作日志，发现距该用户操作10分钟后的一次请求，获取到了经纬度。但是解析后发现这个经纬度与提供信息的用户当前位置有很大的偏差。

::: warning
查询文档以及社区[相关资料](https://developers.weixin.qq.com/community/develop/doc/000a2e96cb8ff0bf935b8730052009?_at=1608014106098)。
1. 定位本身存在一定的误差。
2. 客户端会存在缓存，在一次调用的结果返回前，后续调用会服用该次调用的返回值，多次调用会越来越准。
3. 环境基站信息少 & 没有连接wifi导致获取不到位置。
4. 开启高精度定位才会使用GPS定位。
5. 部分客户端异常，需要在微信里分享一下当前的位置，才可以获取正常的位置信息。

显然，这个问题是出在了源头上。但用户（甲方）不care。
:::

::: danger
#### 补充 2020/12/16
1.通过观察埋点/与其他开发者交流。异常报错会出现404，2，1这几种类型。

2.系统禁止授权给APP时，在小程序内调用getLocation时客户端报错不一致。

* ios：'getLocation:fail system permission denied'
* 安卓：'getLocation:fail:ERROR_SERVER_NOT_LOCATION'; 'getLocation:fail:ERROR_NOCELL&WIFI_LOCATIONSWITCHOFF';
:::

::: danger
#### 补充 2021/3/24
1.wx.getLocation增加调用频率限制[😕](https://developers.weixin.qq.com/community/develop/doc/000aee91a98d206bc6dbe722b51801?idescene=3&op=1&page=5#comment-list)
:::
## 解决方案
::: tip
* 首先在home页检测用户是否打开了GPS，以及是否有授权。未授权则弹窗提示授权。授权成功后调用一次wx.getLocation。
* 用户点击下单进入门店选择列表时，调用wx.getLocation若失败，或返回经纬度为0，0，则弹出自定义弹窗提示用户再次获取。若尝试3次后依旧失败，则提示用户对微信进行一些操作后再次尝试打开小程序。以上操作来解决经纬度获取0，0导致的问题。
* 开启isHighAccuracy参数。该参数要求基础版本库比较高，且效果有待观察。
* 同时提高确认订单时下单门店详细地址信息的显示权重，减少当用户获取的位置与当前位置有偏差导致选错门店的情况。（通过微信后台的反馈，基本上很多用户是不会仔细看门店地址，默认点门店列表的第一家...)
:::

## 总结

在使用某些api时需要多调研下，看是否有坑，做好兼容。后续还需要观察一下，看下此次的操作优化是否可以明显的降低异常情况。
