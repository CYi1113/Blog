---
title: 微信小程序性能优化探索
date: 2020-02-23
tags:
 - 微信小程序 
categories:
 - 小程序
author: 11月
---

<Boxx />

## 前言背景
  由于业务需求的快速迭代，时间紧任务重，且项目由多个同学陆续参与，前期没有较好的统一规范，导致代码有大量重复，小程序代码包的体积蹭蹭在不断增大。从mp后台页面打开时间统计也可以看到时间有明显的提升。对于点餐用户来讲，这个打开时间已经对一部分的敏感用户有明显的体验影响了。至此我认为已经到了必须去解决的地步了。

## 问题探讨/解决方案
  在小程序启动时，微信会在背后完成几项工作：下载小程序代码包、加载小程序代码包、初始化小程序首页。初始化小程序环境是微信环境做的工作,我们只需要控制代码包大小，和通过一些相关的缓存策略控制，和资源控制，逻辑控制，分包加载控制来进行启动加载优化。借助开发者工具`Audits`能力，大致有以下几个方面需要去优化改进。

  1.避免过大的WXML节点数目。
  * 建议一个`page`使用少于`1000`个WXML节点，节点🌲深度少于30层，子节点数不大于`60`个。太大的WXML节点🌲会增加内存的使用，样式重排时间也会更长。
  * 目前优化方式: 
    * 精简代码，去掉不必要的WXML结构和未使用的WXSS定义。 
    * 统计项目中相似度高的业务功能，与负责UI输出的同事讨论UI设计风格统一问题。
    * 抽离相似度高的业务组件封装为公共组件。自定义组件的更新只在组件内部进行，不受页面部分内容的复杂性的影响。
    * 抽离通用样式。
    * 根据mp后台页面访问数统计，页面入口等分析。使用分包加载，剥离部分业务功能为多个[分包](https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages.html)。
    * 勾选开发者工具中，上传时压缩代码（若采用wepy高级版本，自带压缩，请按官网文档采取点击）。
    * 避免白屏，先展示基础内容，使用骨架屏或简单的交互动画等。通过`document.head`查看首页都加载了哪些js。

  2.避免执行的脚本耗时过长的情况
  * 执行脚本的耗时过长会让用户觉得卡顿，体验较差。
  * 目前优化方式:
    * 检查较复杂相关功能实现，优化部分逻辑。
    * 检查定时器是否即时回收。因为定时器是全局的，并不会绑定在某个页面。

  3.图片资源控制
  * 目前优化方式:
    * 压缩图片，使用适当的图片格式，减少本地图片数量，静态图片存储于CDN。访问使用懒加载的方式。
    * 实现通用方法，根据不同的图片展示大小，动态配置请求CDN的裁剪参数。提升加载速度，减小CDN访问流量。
    * 开启缓存。

  4.对网络请求做必要的缓存以避免多余的请求
  * 目前优化方式:
    * 提前做异步请求，页面最好在onLoad时异步请求数据，不要在onReady时请求。
    * 简单实现，在`globalData`里设置`flag`，根据`flag`状态决定是否发送请求。
    * 减少部分页面的并发请求数，与后端同学讨论合并某些接口的可行性。同时我们也在探索GraphQL。
    * TODO: 后续实现请求发送统一管理，离开页面后`pending`状态请求`abort`。
  
  5.所有请求不应耗时太久
  * 目前优化方式:
    * 与后端同学讨论，裁剪部分无用字段返回。减少请求报文体积。
    * 对于qps较高导致请求耗时较久的接口，前端做好用户等待交互，缓解用户等待焦虑。
    * 后端同学对数据库索引优化。

  6.避免短时间内发起太多的请求
  * 短时间内发起太多请求会触发小程序并行请求数量的限制，同时太多请求也可能导致加载慢等问题，应合理控制请求数量。

  7.避免频繁调用`setData`
  * setData接口的调用涉及逻辑层与渲染层间的线程通信，通信过于频繁可能导致处理队列阻塞，界面渲染不及时而导致卡顿，应避免无用的频繁调用。
  * 原由: 小程序的视图层目前使用 WebView 作为渲染载体，而逻辑层是由独立的 JavascriptCore 作为运行环境。在架构上，WebView 和 JavascriptCore 都是独立的模块，并不具备数据直接共享的通道。当前，视图层和逻辑层的数据传输，实际上通过两边提供的 evaluateJavascript 所实现。即用户传输的数据，需要将其转换为字符串形式传递，同时把转换后的数据内容拼接成一份 JS 脚本，再通过执行 JS 脚本的形式传递到两边独立环境。而 evaluateJavascript 的执行会受很多方面的影响，数据到达视图层并不是实时的。
  * 目前优化方式:
    * 减少页面未用到字段的调用。
    * 合并需要操作的数据后调用。
    * 使用`setData`的特殊`key`实现局部更新
    * 页面未使用的字段可以`this._myData=xxx`来更新

  8.避免`setData`的数据过大
  * 目前优化方式:
    * 列表数据分片`setData`。
    * 对于无用字段先过滤后`setData`。

  9.避免出现任何`JavaScript`异常
  * 出现 JavaScript 异常可能导致小程序的交互无法进行下去，我们应当追求零异常，保证小程序的高鲁棒性和高可用性。
  * 不使用废弃接口。使用即将废弃或已废弃接口，可能导致小程序运行不正常。一般而言，接口不会立即去掉，但保险起见，建议不要使用，避免后续小程序突然运行异常。
  * 页面跳转要做一下限制，如果页面快速点击会出现跳转多次的情况。

  10.滚动区域
  * 在页面频繁滚动触发回调函数，会导致页面卡顿，这时必须和防抖动函数或者节流函数相结合做一些处理。
  * 开启惯性滚动以增强体验.惯性滚动会使滚动比较顺畅，在安卓下默认有惯性滚动，而在 iOS 下需要额外设置`-webkit-overflow-scrolling: touch`。

## END