(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{526:function(e,r,t){"use strict";t.r(r);var a=t(2),n=Object(a.a)({},(function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[t("strong",[e._v("本文旨在记录题主搬砖途中所遇所想。")]),e._v(" "),t("Boxx")],1),e._v(" "),t("h2",{attrs:{id:"前言背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言背景"}},[e._v("#")]),e._v(" 前言背景")]),e._v(" "),t("p",[e._v("最近接手了某活动统计报表平台与运营平台的部分需求，其中包含 excel 下载等，想起来之前在营销组时开发灵犀平台遇到的 excel、scv 下载场景，时隔许久也算是补上当时想写但一直未写的坑。")]),e._v(" "),t("h2",{attrs:{id:"解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[e._v("#")]),e._v(" 解决方案")]),e._v(" "),t("p",[e._v("一般来讲下载文件常用的(目前我用过的:)有两种方式:")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("通过 download 接口告知后端需要下载的数据，由后端生成文件存储后返回给前端相应的下载 url，前端通过该 url 进行下载。(清分报表使用该方式，后端每日会有定时任务产生所需下载文件并将处理结果进行缓存，前端请求时直接从缓存获取) 本次不在赘述相关细节。")])]),e._v(" "),t("li",[t("p",[e._v("通过 download 接口告知后端需要下载的数据，后端返回文件流后通过"),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Blob",target:"_blank",rel:"noopener noreferrer"}},[e._v("Blob"),t("OutboundLink")],1),e._v("，以及创建"),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL",target:"_blank",rel:"noopener noreferrer"}},[e._v("对象 URL"),t("OutboundLink")],1),e._v("等操作来实现下载。")])])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("// 以下为简单🌰:\nfunction downloadFile(data, fileName) {\n    let blob = new Blob([data], {\n        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8'\n    })\n\n    if (window.navigator.msSaveBlob) {\n        window.navigator.msSaveBlob(blob, fileName || 'pub.xlsx')\n        return false\n    }\n\n    const aEl = document.createElement('a)\n    const body = document.querySelector('body')\n    aEl.download = fileName || 'pub.xlsl'\n    aEl.style.display = 'none'\n    aEl.href = URL.createObjectURL(blob)\n    body.appendChild(aEl)\n    aEl.click()\n    body.removeChild(aEl)\n    // 释放 URL对象\n    URL.revokeObjectURL(aEl.href)\n}\n\n\n")])])]),t("div",{staticClass:"custom-block warning"},[t("ul",[t("li",[t("p",[e._v("在默认情况下，接口响应的数据类型是 DOMString。由于服务端返回的是文件流，当我们不设置"),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/responseType",target:"_blank",rel:"noopener noreferrer"}},[e._v("responseType"),t("OutboundLink")],1),e._v("为 blob 时，会发现下载的文件发生异常。")])]),e._v(" "),t("li",[t("p",[e._v("该方式在 IE 下需使用"),t("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Navigator/msSaveBlob",target:"_blank",rel:"noopener noreferrer"}},[e._v("msSaveBlob"),t("OutboundLink")],1),e._v("进行兼容处理。")])]),e._v(" "),t("li",[t("p",[e._v("与后端约定返回信息 type，用来判断当前响应状态。当接口响应异常时，由于后端返回的信息是 Blob，其包含的正常错误信息无法捕获，需要先处理为 JSON 格式。")])])])]),e._v(" "),t("h4",{attrs:{id:"正常返回"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#正常返回"}},[e._v("#")]),e._v(" 正常返回:")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://cyi113.oss-cn-shanghai.aliyuncs.com/static/download_msg1.png",alt:""}})]),e._v(" "),t("h4",{attrs:{id:"异常返回"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#异常返回"}},[e._v("#")]),e._v(" 异常返回:")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://cyi113.oss-cn-shanghai.aliyuncs.com/static/download_msg2.png",alt:""}})]),e._v(" "),t("h4",{attrs:{id:"异常返回报文"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#异常返回报文"}},[e._v("#")]),e._v(" 异常返回报文:")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://cyi113.oss-cn-shanghai.aliyuncs.com/static/download_msg3.png",alt:""}})]),e._v(" "),t("p",[e._v("处理异常返回报文"),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader",target:"_blank",rel:"noopener noreferrer"}},[e._v("FileReader"),t("OutboundLink")],1),e._v(":")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("// 简单🌰:\nfunction onClick() {\n    // 请求返回 data，判断返回数据是否正常\n    if (data.type === 'application/json') {\n        handleErrorTip(data)\n        return false\n    }\n\n    // download\n}\n\nfunction handleErrorTip(data) {\n    const fileReader = new FileReader()\n    fileReader.onload = () => {\n        const result = JSON.parse(fileReader.result)\n        this.$message.error(result.message)\n    }\n\n    fileReader.readAsText(data, 'utf-8')\n}\n")])])]),t("h4",{attrs:{id:"监听下载进度"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#监听下载进度"}},[e._v("#")]),e._v(" 监听下载进度")]),e._v(" "),t("p",[e._v("原生 Ajax 有一个监测进度事件"),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/ProgressEvent",target:"_blank",rel:"noopener noreferrer"}},[e._v("progress"),t("OutboundLink")],1),e._v("，该事件会在接收数据发生变化时触发，实际上我们只需要关注该事件返回的 loaded、total 属性值。在实际开发中，使用的第三方封装的请求库时，其已经对该原生事件进行了包装暴露，如 axios 里的 onDownloadProgress，onUploadProgress 方法。")]),e._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),t("p",[e._v("后续会更新大文件下载相关细节，暂时先开个坑。")]),e._v(" "),t("h4",{attrs:{id:"参考信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考信息"}},[e._v("#")]),e._v(" 参考信息")]),e._v(" "),t("ul",[t("li",[t("p",[t("a",{attrs:{href:"https://github.com/eligrey/FileSaver.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("FileSaver"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Blob",target:"_blank",rel:"noopener noreferrer"}},[e._v("Blob"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL",target:"_blank",rel:"noopener noreferrer"}},[e._v("对象 URL"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Navigator/msSaveBlob",target:"_blank",rel:"noopener noreferrer"}},[e._v("msSaveBlob"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader",target:"_blank",rel:"noopener noreferrer"}},[e._v("FileReader"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/responseType",target:"_blank",rel:"noopener noreferrer"}},[e._v("responseType"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types",target:"_blank",rel:"noopener noreferrer"}},[e._v("常见 MIME 类型列表"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/97768916",target:"_blank",rel:"noopener noreferrer"}},[e._v("其他资料"),t("OutboundLink")],1)])])])])}),[],!1,null,null,null);r.default=n.exports}}]);